<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>oneM2M Code Generator - Configure</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.2s ease-in-out;
        }

        .modal-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .modal-header p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .operation-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .operation-option {
            padding: 1.25rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .operation-option:hover {
            border-color: var(--primary-color);
            background: var(--primary-light);
        }

        .operation-option input[type="radio"] {
            margin-top: 0.25rem;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .operation-info {
            flex: 1;
        }

        .operation-info h3 {
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }

        .operation-info p {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        /* GET/POST specific pages */
        .page-container {
            display: none;
        }

        .page-container.active {
            display: block;
        }

        .config-summary {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .config-summary h3 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .config-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .config-row:last-child {
            border-bottom: none;
        }

        .config-label {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .config-value {
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
        }

        .test-panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .response-display {
            display: none;
            margin-top: 1rem;
            background: #f5f5f5;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid var(--border);
        }

        .response-display.active {
            display: block;
        }

        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-badge.success {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.error {
            background: #f8d7da;
            color: #721c24;
        }

        .response-content {
            background: white;
            border-radius: 4px;
            padding: 0.75rem;
            border: 1px solid #ddd;
        }

        .response-content pre {
            margin: 0;
            font-size: 0.85rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
        }

        .generate-section {
            display: none;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .generate-section.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="header-main">
                <div class="header-branding">
                    <div class="header-icon">ðŸš€</div>
                    <div class="header-text">
                        <h1>oneM2M Code Generator</h1>
                        <p class="header-subtitle">Configure your oneM2M client settings</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Indicator -->
    <div class="progress-steps">
        <a href="{{ url_for('index') }}" class="step completed" style="text-decoration: none; color: inherit;">
            <div class="step-number">âœ“</div>
            <div class="step-label">Select Platform</div>
        </a>
        <div class="step-connector completed"></div>
        <div class="step active" id="step2">
            <div class="step-number">2</div>
            <div class="step-label">Configure</div>
        </div>
        <div class="step-connector"></div>
        <div class="step" id="step3">
            <div class="step-number">3</div>
            <div class="step-label">Test & Generate</div>
        </div>
    </div>

    <div class="container config-container">
        <!-- STEP 1: Server Configuration Page -->
        <div id="serverConfigPage" class="page-container active">
            <form id="serverConfigForm">
                <input type="hidden" name="controller" value="{{ controller }}">

                <div class="config-section">
                    <div class="section-header">
                        <h2>Server Configuration</h2>
                        <p class="section-description">Connect to your oneM2M server instance</p>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cse_url">oneM2M Server Host <span class="required">*</span></label>
                            <input type="text" id="cse_url" name="cse_url" 
                                   placeholder="onem2m.iiit.ac.in" required>
                            <span class="error-message"></span>
                        </div>
                        
                        <div class="form-group">
                            <label for="port">Server Port <span class="required">*</span></label>
                            <input type="number" id="port" name="port" 
                                   placeholder="Port 443 = HTTPS | Other ports = HTTP" required>
                            <span class="error-message"></span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="ae_name">Application Entity (AE) <span class="required">*</span></label>
                            <input type="text" id="ae_name" name="ae_name" 
                                   placeholder="AE-SL" required>
                            <span class="error-message"></span>
                        </div>

                        <div class="form-group">
                            <label for="container_name">Container Name <span class="required">*</span></label>
                            <input type="text" id="container_name" name="container_name" 
                                   placeholder="SL-VN03-00" required>
                            <span class="error-message"></span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="origin">Authentication (X-M2M-Origin) <span class="required">*</span></label>
                            <input type="text" id="origin" name="origin" 
                                   placeholder="admin:admin" required>
                            <span class="error-message"></span>
                        </div>
                    </div>
                </div>
                
                <div class="action-section">
                    <div class="action-content">
                        <div class="action-info">
                            <h3>Ready to continue</h3>
                            <p>Fill in all required fields to proceed.</p>
                        </div>
                        <div class="action-buttons">
                            <a href="{{ url_for('index') }}" class="btn btn-secondary">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                    <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Back
                            </a>
                            <button type="button" class="btn btn-primary" onclick="openOperationModal()">
                                Next
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                    <path d="M6 12L10 8L6 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- STEP 2: Operation Selection Modal -->
        <div id="operationModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Choose Operation Type</h2>
                    <p>Select how your device will interact with the oneM2M server</p>
                </div>

                <div class="operation-options">
                    <label class="operation-option">
                        <input type="radio" name="operation" value="GET">
                        <div class="operation-info">
                            <h3>GET â€“ Read Data</h3>
                            <p>Retrieve the latest resource data from the server</p>
                        </div>
                    </label>

                    <label class="operation-option">
                        <input type="radio" name="operation" value="POST">
                        <div class="operation-info">
                            <h3>POST â€“ Send Data</h3>
                            <p>Send sensor data and parameters to the server</p>
                        </div>
                    </label>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeOperationModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="proceedWithOperation()" id="proceedBtn" disabled>
                        Continue
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="margin-left: 0.5rem;">
                            <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- STEP 3a: GET Test Page -->
        <div id="getTestPage" class="page-container">
            <div class="config-section">
                <div class="section-header">
                    <h2>GET Operation Test</h2>
                    <p class="section-description">Test retrieving data from your oneM2M server</p>
                </div>

                <!-- Server Configuration Summary -->
                <div class="config-summary">
                    <h3>Server Configuration</h3>
                    <div class="config-row">
                        <span class="config-label">Host:</span>
                        <span class="config-value" id="summary-host"></span>
                    </div>
                    <div class="config-row">
                        <span class="config-label">Port:</span>
                        <span class="config-value" id="summary-port"></span>
                    </div>
                    <div class="config-row">
                        <span class="config-label">Protocol:</span>
                        <span class="config-value" id="summary-protocol"></span>
                    </div>
                    <div class="config-row">
                        <span class="config-label">AE Name:</span>
                        <span class="config-value" id="summary-ae"></span>
                    </div>
                    <div class="config-row">
                        <span class="config-label">Container:</span>
                        <span class="config-value" id="summary-container"></span>
                    </div>
                    <div class="config-row">
                        <span class="config-label">Endpoint:</span>
                        <span class="config-value" id="summary-endpoint"></span>
                    </div>
                </div>

                <!-- Test Panel -->
                <div class="test-panel">
                    <h3>Test Connection</h3>
                    <p style="color: var(--text-secondary); margin: 0.5rem 0 1rem;">Click below to test GET request and retrieve the latest resource</p>
                    
                    <button type="button" class="btn btn-primary" onclick="testGetOperation()" id="testGetBtn">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="margin-right: 0.5rem;">
                            <path d="M13 3L3 13M13 3H7M13 3V9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span id="testGetBtnText">Test GET Request</span>
                    </button>

                    <!-- Response Display -->
                    <div id="getResponseDisplay" class="response-display">
                        <div class="response-header">
                            <h4 style="margin: 0; font-size: 0.95rem; font-weight: 600;">Response</h4>
                            <span id="getStatusBadge" class="status-badge"></span>
                        </div>
                        <div class="response-content">
                            <pre id="getResponseContent"></pre>
                        </div>
                    </div>
                </div>

                <!-- Generate Code Section (appears after successful test) -->
                <div id="getGenerateSection" class="generate-section">
                    <div class="action-content">
                        <div class="action-info">
                            <h3>âœ“ Test Successful!</h3>
                            <p>Your GET configuration works. Generate device-specific code now.</p>
                        </div>
                        <div class="action-buttons">
                            <button type="button" class="btn btn-secondary" onclick="goBackToServer()">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                    <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Back
                            </button>
                            <button type="button" class="btn btn-primary" onclick="generateCode()">
                                Generate GET Code
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                    <path d="M6 12L10 8L6 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- STEP 3b: POST Parameters Page -->
        <div id="postParamsPage" class="page-container">
            <div class="config-section">
                <div class="section-header">
                    <h2>POST Operation Configuration</h2>
                    <p class="section-description">Define data parameters to send to the server</p>
                </div>

                <!-- Parameters Section -->
                <div id="parametersContainer" class="parameters-grid">
                    <!-- Parameters will be added here dynamically -->
                </div>

                <div style="margin-top:1rem; display:flex; gap:0.75rem; align-items:center;">
                    <button type="button" class="btn btn-secondary" onclick="addParameter()">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="margin-right:6px;">
                            <path d="M8 3V13M3 8H13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        Add Parameter
                    </button>
                    <div style="color:var(--text-tertiary); font-size:0.875rem;">You can add up to 20 fields</div>
                </div>

                <!-- Labels Section -->
                <div class="config-section" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                    <div class="section-header">
                        <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem;">Labels (Optional)</h3>
                        <p class="section-description" style="font-size: 0.875rem;">Add labels to categorize your data</p>
                    </div>

                    <div id="labelsContainer" class="parameters-grid">
                        <!-- Labels will be added here dynamically -->
                    </div>

                    <div style="margin-top:1rem; display:flex; gap:0.75rem; align-items:center;">
                        <button type="button" class="btn btn-secondary" onclick="addLabel()">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="margin-right:6px;">
                                <path d="M8 3V13M3 8H13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            Add Label
                        </button>
                        <div style="color:var(--text-tertiary); font-size:0.875rem;">You can add up to 10 labels</div>
                    </div>
                </div>

                <!-- Test Panel -->
                <div class="test-panel" style="margin-top: 2rem;">
                    <h3>Test POST Request</h3>
                    <p style="color: var(--text-secondary); margin: 0.5rem 0 1rem;">Test sending data to the server with your configured parameters</p>
                    
                    <button type="button" class="btn btn-primary" onclick="testPostOperation()" id="testPostBtn">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="margin-right: 0.5rem;">
                            <path d="M2 8L6 12L14 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span id="testPostBtnText">Test POST Request</span>
                    </button>

                    <!-- Response Display -->
                    <div id="postResponseDisplay" class="response-display">
                        <div class="response-header">
                            <h4 style="margin: 0; font-size: 0.95rem; font-weight: 600;">Response</h4>
                            <span id="postStatusBadge" class="status-badge"></span>
                        </div>
                        <div class="response-content">
                            <pre id="postResponseContent"></pre>
                        </div>
                    </div>
                </div>

                <!-- Generate Code Section (appears after successful test) -->
                <div id="postGenerateSection" class="generate-section">
                    <div class="action-content">
                        <div class="action-info">
                            <h3>âœ“ Test Successful!</h3>
                            <p>Your POST configuration works. Generate device-specific code now.</p>
                        </div>
                        <div class="action-buttons">
                            <button type="button" class="btn btn-secondary" onclick="goBackToServer()">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                    <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Back
                            </button>
                            <button type="button" class="btn btn-primary" onclick="generateCode()">
                                Generate POST Code
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                    <path d="M6 12L10 8L6 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let serverConfig = {};
        let selectedOperation = '';
        let parameterCount = 1;
        let labelCount = 1;
        let testPassed = false;

        // Server config validation and modal opening
        function openOperationModal() {
            // Validate all required fields
            const cseUrl = document.getElementById('cse_url').value.trim();
            const port = document.getElementById('port').value.trim();
            const aeName = document.getElementById('ae_name').value.trim();
            const containerName = document.getElementById('container_name').value.trim();
            const origin = document.getElementById('origin').value.trim();

            if (!cseUrl || !port || !aeName || !containerName || !origin) {
                alert('Please fill in all required fields before proceeding.');
                return;
            }

            // Store server config
            serverConfig = {
                controller: '{{ controller }}',
                cse_url: cseUrl,
                port: parseInt(port),
                protocol: (parseInt(port) === 443) ? 'https' : 'http',
                ae_name: aeName,
                container_name: containerName,
                origin: origin
            };

            // Show modal
            document.getElementById('operationModal').classList.add('active');
        }

        function closeOperationModal() {
            document.getElementById('operationModal').classList.remove('active');
        }

        // Operation selection
        document.addEventListener('DOMContentLoaded', function() {
            const operationRadios = document.querySelectorAll('input[name="operation"]');
            const proceedBtn = document.getElementById('proceedBtn');

            operationRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    selectedOperation = this.value;
                    proceedBtn.disabled = false;
                });
            });

            // Auto-strip protocol from CSE URL
            const cseUrlField = document.getElementById('cse_url');
            if (cseUrlField) {
                cseUrlField.addEventListener('input', function() {
                    let value = this.value;
                    if (value.match(/^https?:\/\//i)) {
                        this.value = value.replace(/^https?:\/\//i, '');
                    }
                });
            }

            // Initialize parameter and label fields
            generateParameterFields();
            generateLabelFields();
        });

        function proceedWithOperation() {
            if (!selectedOperation) return;

            closeOperationModal();

            // Hide server config page
            document.getElementById('serverConfigPage').classList.remove('active');

            // Update progress
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step2').classList.add('completed');
            document.getElementById('step2').querySelector('.step-number').textContent = 'âœ“';
            document.getElementById('step3').classList.add('active');

            if (selectedOperation === 'GET') {
                showGetTestPage();
            } else {
                showPostParamsPage();
            }
        }

        // GET Test Page
        function showGetTestPage() {
            const page = document.getElementById('getTestPage');
            page.classList.add('active');

            // Populate summary
            document.getElementById('summary-host').textContent = serverConfig.cse_url;
            document.getElementById('summary-port').textContent = serverConfig.port;
            document.getElementById('summary-protocol').textContent = serverConfig.protocol.toUpperCase();
            document.getElementById('summary-ae').textContent = serverConfig.ae_name;
            document.getElementById('summary-container').textContent = serverConfig.container_name;
            
            const endpoint = `${serverConfig.protocol}://${serverConfig.cse_url}:${serverConfig.port}/~/in-cse/in-name/${serverConfig.ae_name}/${serverConfig.container_name}/la`;
            document.getElementById('summary-endpoint').textContent = endpoint;
        }

        async function testGetOperation() {
            const testBtn = document.getElementById('testGetBtn');
            const btnText = document.getElementById('testGetBtnText');
            const responseDisplay = document.getElementById('getResponseDisplay');
            const generateSection = document.getElementById('getGenerateSection');

            testBtn.disabled = true;
            btnText.textContent = 'Testing...';
            responseDisplay.classList.remove('active');
            generateSection.classList.remove('active');

            try {
                const response = await fetch('/test-get', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(serverConfig)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showResponse('get', true, result.status_code, result.response, result.url);
                    testPassed = true;
                    generateSection.classList.add('active');
                } else {
                    showResponse('get', false, result.status_code || 'Error', result.error || result.response || 'Test failed', result.url);
                    testPassed = false;
                }
            } catch (error) {
                showResponse('get', false, 'Error', `Test failed: ${error.message}`);
                testPassed = false;
            } finally {
                testBtn.disabled = false;
                btnText.textContent = 'Test GET Request';
            }
        }

        // POST Parameters Page
        function showPostParamsPage() {
            const page = document.getElementById('postParamsPage');
            page.classList.add('active');
        }

        async function testPostOperation() {
            const testBtn = document.getElementById('testPostBtn');
            const btnText = document.getElementById('testPostBtnText');
            const responseDisplay = document.getElementById('postResponseDisplay');
            const generateSection = document.getElementById('postGenerateSection');

            testBtn.disabled = true;
            btnText.textContent = 'Testing...';
            responseDisplay.classList.remove('active');
            generateSection.classList.remove('active');

            // Collect parameters
            const parameters = [];
            for (let i = 0; i < parameterCount; i++) {
                const name = document.querySelector(`[name="param_name_${i}"]`)?.value || '';
                const type = document.querySelector(`[name="param_type_${i}"]`)?.value || 'string';
                const defaultVal = document.querySelector(`[name="param_default_${i}"]`)?.value || '';
                
                if (name) {
                    parameters.push({ name, type, default: defaultVal || '0' });
                }
            }

            // Collect labels
            const labels = [];
            for (let i = 0; i < labelCount; i++) {
                const labelValue = document.querySelector(`[name="label_${i}"]`)?.value;
                if (labelValue && labelValue.trim()) {
                    labels.push(labelValue.trim());
                }
            }

            const postConfig = {
                ...serverConfig,
                parameters,
                labels
            };

            try {
                const response = await fetch('/test-post', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(postConfig)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showResponse('post', true, result.status_code, result.response, result.url);
                    testPassed = true;
                    generateSection.classList.add('active');
                    
                    // Store parameters and labels for code generation
                    serverConfig.parameters = parameters;
                    serverConfig.labels = labels;
                } else {
                    showResponse('post', false, result.status_code || 'Error', result.error || result.response || 'Test failed', result.url);
                    testPassed = false;
                }
            } catch (error) {
                showResponse('post', false, 'Error', `Test failed: ${error.message}`);
                testPassed = false;
            } finally {
                testBtn.disabled = false;
                btnText.textContent = 'Test POST Request';
            }
        }

        // Show response helper
        function showResponse(type, success, statusCode, responseText, url = '') {
            const prefix = type; // 'get' or 'post'
            const display = document.getElementById(`${prefix}ResponseDisplay`);
            const badge = document.getElementById(`${prefix}StatusBadge`);
            const content = document.getElementById(`${prefix}ResponseContent`);

            display.classList.add('active');

            if (success) {
                badge.className = 'status-badge success';
                badge.textContent = `âœ“ ${statusCode}`;
            } else {
                badge.className = 'status-badge error';
                badge.textContent = `âœ— ${statusCode}`;
            }

            // Try to pretty-print JSON
            let displayText = responseText;
            try {
                const jsonObj = JSON.parse(responseText);
                displayText = JSON.stringify(jsonObj, null, 2);
            } catch (e) {
                // Not JSON, display as is
            }

            if (url) {
                content.textContent = `URL: ${url}\n\n${displayText}`;
            } else {
                content.textContent = displayText;
            }
        }

        // Parameter management
        function generateParameterFields() {
            const container = document.getElementById('parametersContainer');
            container.innerHTML = '';

            for (let i = 0; i < parameterCount; i++) {
                const paramCard = document.createElement('div');
                paramCard.className = 'parameter-card';
                paramCard.innerHTML = `
                    <div class="param-header">
                        <span class="param-badge">Parameter ${i + 1}</span>
                        ${parameterCount > 1 ? `<button type="button" class="btn-remove-param" onclick="removeParameter(${i})" aria-label="Remove parameter">Ã—</button>` : ''}
                    </div>
                    <div class="param-fields">
                        <div class="form-group">
                            <label>Field Name <span class="required">*</span></label>
                            <input type="text" name="param_name_${i}" placeholder="temperature | humidity | status" required>
                        </div>
                        <div class="form-group">
                            <label>Data Type <span class="required">*</span></label>
                            <select name="param_type_${i}" required>
                                <option value="">Select type...</option>
                                <option value="int">Integer</option>
                                <option value="float">Decimal</option>
                                <option value="string">Text</option>
                                <option value="boolean">True/False</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Default Value</label>
                            <input type="text" name="param_default_${i}" placeholder="25 | 0.0 | hello | true">
                        </div>
                    </div>
                `;
                container.appendChild(paramCard);
            }
        }

        function addParameter() {
            if (parameterCount < 20) {
                parameterCount++;
                generateParameterFields();
            }
        }

        function removeParameter(index) {
            if (parameterCount > 1) {
                parameterCount--;
                generateParameterFields();
            }
        }

        // Label management
        function generateLabelFields() {
            const container = document.getElementById('labelsContainer');
            container.innerHTML = '';

            for (let i = 0; i < labelCount; i++) {
                const labelCard = document.createElement('div');
                labelCard.className = 'parameter-card';
                labelCard.innerHTML = `
                    <div class="param-header">
                        <span class="param-badge">Label ${i + 1}</span>
                        ${labelCount > 1 ? `<button type="button" class="btn-remove-param" onclick="removeLabel(${i})" aria-label="Remove label">Ã—</button>` : ''}
                    </div>
                    <div class="param-fields">
                        <div class="form-group">
                            <label>Label Value</label>
                            <input type="text" name="label_${i}" placeholder="AE-EM | V2.0.0 | EM-CR-KH95-00">
                        </div>
                    </div>
                `;
                container.appendChild(labelCard);
            }
        }

        function addLabel() {
            if (labelCount < 10) {
                labelCount++;
                generateLabelFields();
            }
        }

        function removeLabel(index) {
            if (labelCount > 1) {
                labelCount--;
                generateLabelFields();
            }
        }

        // Code generation
        async function generateCode() {
            if (!testPassed) {
                alert('Please test your configuration first before generating code.');
                return;
            }

            const config = {
                ...serverConfig,
                operation: selectedOperation
            };

            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const result = await response.json();

                if (!response.ok) {
                    alert('Error: ' + (result.error || 'Failed to generate code'));
                    return;
                }

                // Store in sessionStorage and redirect
                sessionStorage.setItem('generatedCode', result.code);
                sessionStorage.setItem('filename', result.filename);
                sessionStorage.setItem('controller', result.controller);
                
                window.location.href = '/generate-view';
            } catch (error) {
                alert('Error generating code: ' + error.message);
            }
        }

        function goBackToServer() {
            // Hide current pages
            document.getElementById('getTestPage').classList.remove('active');
            document.getElementById('postParamsPage').classList.remove('active');

            // Show server config page
            document.getElementById('serverConfigPage').classList.add('active');

            // Reset progress
            document.getElementById('step2').classList.add('active');
            document.getElementById('step2').classList.remove('completed');
            document.getElementById('step2').querySelector('.step-number').textContent = '2';
            document.getElementById('step3').classList.remove('active');

            // Reset test state
            testPassed = false;
            selectedOperation = '';
        }
    </script>

    <div class="footer">
        <div class="footer-center">
            <p>oneM2M Code Generator &copy; 2025</p>
        </div>
        <a href="https://himanshu-portfolio-beryl.vercel.app/" target="_blank" class="developer-credit">
            &lt;/&gt; Developed by Himanshu Fanibhare
        </a>
    </div>
</body>
</html>
